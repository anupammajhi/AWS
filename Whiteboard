# Function to get accounts with OU path
function Get-AccountsWithOUPath {
    param(
        [Amazon.PowerShell.Common.AmazonOrganizationsClient]$OrgClient,
        [string]$OUId,
        [string]$Path
    )

    # List of accounts at this OU
    $ouList = @()

    # I. Get further children OUs
    $paginator = $OrgClient.GetPaginator('ListChildren')
    $pages = $paginator.Paginate(
        @{
            ParentId = $OUId
            ChildType = 'ORGANIZATIONAL_UNIT'
        }
    )

    foreach ($page in $pages) {
        foreach ($child in $page.Children) {
            $ouList += Get-AccountsWithOUPath -OrgClient $OrgClient -OUId $child.Id -Path ($Path + $OUId + '/')
        }
    }

    # II. Get Accounts located at OU
    $pages = $paginator.Paginate(
        @{
            ParentId = $OUId
            ChildType = 'ACCOUNT'
        }
    )

    foreach ($page in $pages) {
        foreach ($child in $page.Children) {
            $ouList += ($Path + $OUId + '/' + $child.Id)
        }
    }

    return $ouList
}

# AWS CLI command to get account list with OU path
$accountList = Get-AccountsWithOUPath -OrgClient (aws organizations) -OUId 'r-xxxx' -Path '/'

# Print the result
Write-Output $accountList